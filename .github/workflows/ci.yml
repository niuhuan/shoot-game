name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-check-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Check native build
        run: cargo check

  build-native:
    name: Build Native
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev libxkbcommon-dev

      - name: Build
        run: cargo build --release

  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-wasm-${{ hashFiles('**/Cargo.lock') }}

      - name: Install wasm-bindgen-cli
        run: cargo install wasm-bindgen-cli

      - name: Fetch font asset
        run: |
          mkdir -p assets
          if [ ! -s assets/NotoSansCJKsc-Regular.full.otf ]; then
            curl -L --fail --retry 3 --retry-delay 1 \
              -o assets/NotoSansCJKsc-Regular.full.otf \
              https://github.com/notofonts/noto-cjk/raw/refs/heads/main/Sans/OTF/SimplifiedChinese/NotoSansCJKsc-Regular.otf
          fi

      - name: Subset font (UI glyphs)
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install fonttools
          python3 tools/subset_font.py \
            --input assets/NotoSansCJKsc-Regular.full.otf \
            --output assets/NotoSansCJKsc-Regular.otf \
            --roots src \
            --roots web

      - name: Build WASM
        run: cargo build --release --target wasm32-unknown-unknown --no-default-features --features web

      - name: Generate bindings
        run: |
          mkdir -p dist
          wasm-bindgen \
            --out-dir dist \
            --target web \
            --no-typescript \
            target/wasm32-unknown-unknown/release/shoot.wasm

      - name: Copy web assets
        run: |
          cp web/index.html dist/
          cp web/style.css dist/
          cp -r assets dist/
          rm -f dist/assets/NotoSansCJKsc-Regular.full.otf

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm-build
          path: dist/
          retention-days: 7

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev libxkbcommon-dev

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests
        run: cargo test --all-features
